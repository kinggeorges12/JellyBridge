<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <title>Jellyseerr Bridge v0.24 - FIXED PLUGIN LOADING</title>
</head>
<body>
<div data-role="page" id="jellyseerrBridgeConfigurationPage" class="page type-interior pluginConfigurationPage fullWidthContent">
    <div class="content-primary">
        <div class="verticalSection">
            <div class="sectionTitleContainer">
                <h2 class="sectionTitle">Jellyseerr Bridge</h2>
                <a is="emby-linkbutton" class="raised raised-mini" style="margin-left: 2em;" target="_blank"
                   href="https://github.com/kinggeorges12/Jellyseerr-Bridge">
                    <i class="md-icon button-icon button-icon-left secondaryText"></i>
                    <span>Help</span>
                </a>
            </div>
        </div>
        <hr class="solid">

        <form class="jellyseerrBridgeConfigurationForm">
            <div class="verticalSection">
                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused">Jellyseerr URL</label>
                    <input id="jellyseerrUrl" type="text" is="emby-input" class="emby-input" placeholder="http://localhost:5055">
                    <div class="fieldDescription">The base URL of your Jellyseerr instance</div>
                </div>
                
                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused">API Key</label>
                    <input id="apiKey" type="password" is="emby-input" class="emby-input" placeholder="Your Jellyseerr API key">
                    <div class="fieldDescription">Your Jellyseerr API key (found in Settings → General)</div>
                </div>
                
                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused">Library Directory</label>
                    <input id="libraryDirectory" type="text" is="emby-input" class="emby-input" placeholder="/data/Jellyseerr">
                    <div class="fieldDescription">Path to Jellyseerr's library directory</div>
                </div>
                
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="emby-checkbox-label">
                        <input id="excludeFromMainLibraries" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox">
                        <span class="checkboxLabel">Exclude placeholder shows from main libraries</span>
                        <span class="checkboxOutline">
                            <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                            <span class="material-icons checkboxIcon checkboxIcon-unchecked" aria-hidden="true"></span>
                        </span>
                    </label>
                    <div class="fieldDescription checkboxFieldDescription">Prevents placeholder shows from appearing in your main Jellyfin libraries</div>
                </div>
                
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="emby-checkbox-label">
                        <input id="createSeparateLibraries" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox">
                        <span class="checkboxLabel">Create separate libraries for streaming services</span>
                        <span class="checkboxOutline">
                            <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                            <span class="material-icons checkboxIcon checkboxIcon-unchecked" aria-hidden="true"></span>
                        </span>
                    </label>
                    <div class="fieldDescription checkboxFieldDescription">Creates dedicated libraries for each streaming service (e.g., 'Streaming - Netflix')</div>
                </div>
                
                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused">Library Prefix</label>
                    <input id="libraryPrefix" type="text" is="emby-input" class="emby-input" placeholder="Streaming - ">
                    <div class="fieldDescription">Prefix for streaming service libraries</div>
                </div>
                
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="emby-checkbox-label">
                        <input id="isEnabled" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox">
                        <span class="checkboxLabel">Enable Plugin</span>
                        <span class="checkboxOutline">
                            <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                            <span class="material-icons checkboxIcon checkboxIcon-unchecked" aria-hidden="true"></span>
                        </span>
                    </label>
                    <div class="fieldDescription checkboxFieldDescription">Enable or disable the plugin</div>
                </div>
                
                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused">Sync Interval (hours)</label>
                    <input id="syncIntervalHours" type="number" is="emby-input" class="emby-input" min="1" max="168" placeholder="24">
                    <div class="fieldDescription">How often to sync shows (1-168 hours)</div>
                </div>
                
                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused">Webhook Port</label>
                    <input id="webhookPort" type="number" is="emby-input" class="emby-input" min="1024" max="65535" placeholder="5000">
                    <div class="fieldDescription">Port for webhook events (1024-65535)</div>
                </div>
                
                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused">Jellyseerr User ID</label>
                    <input id="userId" type="number" is="emby-input" class="emby-input" min="1" placeholder="1">
                    <div class="fieldDescription">Jellyseerr user ID for making requests (found in Jellyseerr user management)</div>
                </div>
            </div>
            
            <div class="verticalSection">
                <button id="testConnection" is="emby-button" type="button" class="emby-button raised button-submit" style="margin-right: 10px;">
                    Test Connection
                </button>
                <button id="triggerSync" is="emby-button" type="button" class="emby-button raised button-submit">
                    Trigger Sync
                </button>
            </div>
            
            <div class="verticalSection">
                <button id="saveConfig" is="emby-button" type="submit" class="emby-button raised button-submit" style="width: 100%;">
                    Save Configuration
                </button>
            </div>
        </form>
    </div>
    
    <script type="text/javascript">
        (function () {
            'use strict';
            
            const pluginId = "8ecc808c-d6e9-432f-9219-b638fbfb37e6";
            
            function saveConfig(e) {
                e.preventDefault();
                Dashboard.showLoadingMsg();
                
                const config = {
                    JellyseerrUrl: document.querySelector("#jellyseerrUrl").value,
                    ApiKey: document.querySelector("#apiKey").value,
                    LibraryDirectory: document.querySelector("#libraryDirectory").value,
                    CreateSeparateLibraries: document.querySelector("#createSeparateLibraries").checked,
                    LibraryPrefix: document.querySelector("#libraryPrefix").value,
                    ExcludeFromMainLibraries: document.querySelector("#excludeFromMainLibraries").checked,
                    IsEnabled: document.querySelector("#isEnabled").checked,
                    SyncIntervalHours: parseInt(document.querySelector("#syncIntervalHours").value) || 24,
                    WebhookPort: parseInt(document.querySelector("#webhookPort").value) || 5000,
                    UserId: parseInt(document.querySelector("#userId").value) || 1
                };

                ApiClient.updatePluginConfiguration(pluginId, config)
                    .then(Dashboard.processPluginConfigurationUpdateResult)
                    .catch(function (error) {
                        console.error(error);
                        Dashboard.alert("Error saving configuration: " + error.message);
                    })
                    .finally(function () {
                        Dashboard.hideLoadingMsg();
                    });
            }
            
            function loadConfig() {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(pluginId)
                    .then(function (config) {
                        if (config) {
                            document.querySelector("#jellyseerrUrl").value = config.JellyseerrUrl || "";
                            document.querySelector("#apiKey").value = config.ApiKey || "";
                            document.querySelector("#libraryDirectory").value = config.LibraryDirectory || "/data/Jellyseerr";
                            document.querySelector("#createSeparateLibraries").checked = config.CreateSeparateLibraries || false;
                            document.querySelector("#libraryPrefix").value = config.LibraryPrefix || "Streaming - ";
                            document.querySelector("#excludeFromMainLibraries").checked = config.ExcludeFromMainLibraries || false;
                            document.querySelector("#isEnabled").checked = config.IsEnabled || false;
                            document.querySelector("#syncIntervalHours").value = config.SyncIntervalHours || 24;
                            document.querySelector("#webhookPort").value = config.WebhookPort || 5000;
                            document.querySelector("#userId").value = config.UserId || 1;
                        }
                    })
                    .catch(function (error) {
                        console.error(error);
                        Dashboard.alert("Error loading configuration: " + error.message);
                    })
                    .finally(function () {
                        Dashboard.hideLoadingMsg();
                    });
            }
            
            function testConnection() {
                Dashboard.showLoadingMsg();
                
                // Use the proper Jellyfin API client method
                ApiClient.ajax({
                    url: ApiClient.getUrl("/Plugins/JellyseerrBridge/TestConnection"),
                    type: "POST",
                    dataType: "json"
                }).done(function (data) {
                    console.log("Test connection response:", data);
                    if (data && data.success) {
                        Dashboard.alert("✅ " + data.message);
                    } else {
                        Dashboard.alert("❌ " + (data.message || "Connection test failed"));
                    }
                }).fail(function (xhr, status, error) {
                    console.error("Test connection error:", error);
                    Dashboard.alert("❌ Connection test failed: " + (error || "Unknown error"));
                }).always(function () {
                    Dashboard.hideLoadingMsg();
                });
            }
            
            function triggerSync() {
                Dashboard.showLoadingMsg();
                ApiClient.ajax({
                    url: ApiClient.getUrl("/Plugins/JellyseerrBridge/Sync"),
                    type: "POST",
                    dataType: "json"
                }).done(function (data) {
                    Dashboard.alert("Sync triggered successfully!");
                }).fail(function (xhr, status, error) {
                    console.error(error);
                    Dashboard.alert("Sync failed: " + error);
                }).always(function () {
                    Dashboard.hideLoadingMsg();
                });
            }
            
            function init() {
                const btnSave = document.querySelector("#saveConfig");
                const btnTestConnection = document.querySelector("#testConnection");
                const btnTriggerSync = document.querySelector("#triggerSync");
                
                if (btnSave) {
                    btnSave.addEventListener("click", saveConfig);
                }
                if (btnTestConnection) {
                    btnTestConnection.addEventListener("click", testConnection);
                }
                if (btnTriggerSync) {
                    btnTriggerSync.addEventListener("click", triggerSync);
                }
                
                loadConfig();
            }

            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</div>
</body>
</html>
</html>