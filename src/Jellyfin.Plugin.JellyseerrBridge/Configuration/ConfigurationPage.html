<div id="jellyseerrBridgeConfigurationPage" data-role="page" class="page type-interior pluginConfigurationPage" data-controller="__plugin/ConfigurationPage.js">
    <div data-role="content">
        <div class="content-primary">
            <style>
                summary {
                    cursor: pointer;
                    padding: 10px;
                    width: inherit;
                    margin: auto;
                    border: none;
                    text-align: center;
                    font-size: 1em;
                    outline: 2px solid rgba(155, 155, 155, 0.5);
                }
                h3.checkboxListLabel {
                    font-size: 1em;
                    margin-bottom: 4px;
                }
                /* Disabled state styling */
                .disabled-block {
                    opacity: .6;
                }
                .disabled-block input,
                .disabled-block select,
                .disabled-block button {
                    pointer-events: none;
                }
                .disabled-block .inputLabel,
                .disabled-block label.emby-checkbox-label span {
                    font-style: italic;
                }
                
                /* Multi-select styling */
                .multiSelectContainer {
                    display: flex;
                    gap: 20px;
                    margin-top: 10px;
                    align-items: stretch;
                }
                
                .selectBoxHeader {
                    display: flex;
                    align-items: center;
                    margin-bottom: 8px;
                }
                
                .selectBoxHeader .inputLabel {
                    margin: 0;
                    flex: 1;
                }
                
                .arrowButtonsContainer {
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    width: 10%
                }
                
                .arrowButton {
                    font-size: 18px;
                    font-weight: bold;
                    width: 40px;
                    height: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-bottom: 5px;
                }
                
                .selectBox {
                    width: 45%;
                }
                
                .selectBox .emby-select {
                    min-height: 200px;
                    flex: 1;
                    margin-bottom: 8px;
                }
                
                /* Scrollbar styling for emby-select */
                .emby-select::-webkit-scrollbar {
                    width: 20px;
                    height: 12px;
                }
                
                .emby-select::-webkit-scrollbar-track {
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: 6px;
                }
                
                .emby-select::-webkit-scrollbar-thumb {
                    background: rgba(255, 255, 255, 0.3);
                    border-radius: 6px;
                    border: 2px solid transparent;
                    background-clip: content-box;
                }
                
                .emby-select::-webkit-scrollbar-thumb:hover {
                    background: rgba(255, 255, 255, 0.5);
                    background-clip: content-box;
                }
                
                /* Help icon styling */
                .helpIcon {
                    display: inline-block;
                    width: 24px;
                    height: 24px;
                    background: #0078d4;
                    color: white;
                    border-radius: 50%;
                    text-align: center;
                    line-height: 24px;
                    font-size: 16px;
                    font-weight: bold;
                    margin-left: 5px;
                    cursor: help;
                    vertical-align: middle;
                }
                
                .helpIcon:hover {
                    background: #106ebe;
                }
                
                #IsEnabledContainer {
                    display: flex;
                    flex:0;
                    white-space: nowrap;
                }
                
                .helpButton {
                    display: flex;
                    flex: 1;
                    width: 32px;
                    height: 32px;
                    line-height: 32px;
                    align-items: center;
                }
                
                .cautionText {
                    color: #ff9800;
                    font-size: 0.85em;
                    margin-top: 8px;
                }
                
                .criticalText {
                    color: #ff6b6b;
                    font-size: 0.85em;
                    margin-top: 8px;
                }
                
                .setupInstructions {
                    border-radius: 4px;
                    padding: 0px;
                    margin-top: 0px;
                    margin-bottom: 16px;
                }

                /* Search input with clear button */
                .searchInputContainer {
                    position: relative;
                    margin-bottom: 8px;
                }
                
                .searchInputContainer .emby-input {
                    padding-right: 30px;
                    margin-bottom: 0;
                }
                
                .clearSearchButton {
                    position: absolute;
                    right: 8px;
                    top: 50%;
                    transform: translateY(-50%);
                    background: none;
                    border: none;
                    color: #999;
                    font-size: 18px;
                    font-weight: bold;
                    cursor: pointer;
                    padding: 0;
                    width: 20px;
                    height: 20px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 50%;
                    transition: all 0.2s ease;
                }
                
                .clearSearchButton:hover {
                    background-color: #666;
                    color: #fff;
                }
                
                .clearSearchButton:not([style*="display: none"]) {
                    display: flex;
                }
                
                /* Disabled state for Library Prefix */
                .disabled {
                    opacity: 0.6;
                    pointer-events: none;
                }
                
                .disabled .inputLabel,
                .disabled label,
                .disabled .emby-input-label {
                    color: #999 !important;
                }
                
                /* Allow pointer events on help icon even when container is disabled */
                .disabled .helpIcon {
                    pointer-events: auto;
                    cursor: pointer;
                }
                
                /* Disabled button styling */
                button:disabled {
                    opacity: 0.6;
                    pointer-events: none;
                }
                
                /* Refresh button styling */
                .refreshButton {
                    background: none;
                    border: none;
                    padding: 0;
                    margin: 0;
                    cursor: pointer;
                    font-size: inherit;
                    transition: transform 0.2s ease;
                }
                
                .refreshButton:hover {
                    transform: rotate(180deg);
                }
                
                /* Task status container styling */
                .taskStatusContainer {
                    margin-bottom: 20px;
                    padding: 15px;
                    background-color: rgba(0, 0, 0, 0.1);
                    border-radius: 8px;
                }
                
                .taskStatusHeader {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 10px;
                }
                
                .taskStatusHeader h3 {
                    margin: 0;
                    font-size: 1.1em;
                }
                
                .taskStatusText {
                    font-weight: bold;
                    color: #666;
                }
                
                .taskProgressContainer {
                    display: none;
                }
                
                .taskProgressText {
                    text-align: center;
                    margin-top: 5px;
                    font-size: 0.9em;
                    color: #999;
                }
                
                .taskStatusTimes {
                    font-size: 0.85em;
                    color: #888;
                    margin-top: 8px;
                }
            </style>
            <form id="jellyseerrBridgeConfigurationForm">
                <fieldset class="verticalSection-extrabottompadding">
                    <legend>Jellyseerr Bridge Configuration</legend>
                    
                    <!-- Task Status Progress Bar -->
                    <div id="taskStatusContainer" class="taskStatusContainer">
                        <div class="taskStatusHeader">
                            <h3>
                                <button type="button" id="refreshTaskStatus" is="emby-button" class="refreshButton" title="Refresh status">🔄</button> Scheduled Sync Status
                            </h3>
                            <span id="taskStatusText" class="taskStatusText">Checking...</span>
                        </div>
                        <div id="taskProgressContainer" class="taskProgressContainer">
                            <div class="itemProgressBar">
                                <div class="itemProgressBarForeground" id="taskProgressBar" style="width: 0%;"></div>
                            </div>
                            <div id="taskProgressText" class="taskProgressText"></div>
                        </div>
                        <div id="taskStatusTimes" class="taskStatusTimes"></div>
                    </div>
                    
                    <div class="checkboxContainer">
                        <label class="emby-checkbox-label" id="IsEnabledContainer">
                            <input id="IsEnabled" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox" />
                            <span class="checkboxLabel">Enable the automated task to sync Jellyseerr and Jellyfin</span>
                            <span class="checkboxOutline">
                                <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                                <span class="material-icons checkboxIcon checkboxIcon-unchecked" aria-hidden="true"></span>
                            </span>
                        </label>
                        <div class="helpButton">
                            <span class="helpIcon" id="librarySetupHelp" title="Click me! Show library setup instruction.">?</span>
                        </div>
                    </div>
                    
                    <div id="librarySetupInstructions" class="setupInstructions verticalSection" style="display: none;">
                        <h4>Library Setup Instructions</h4>
                        <p>Before enabling this plugin, we recommend that you create an empty library. Use the following settings:</p>
                        <ul>
                            <li><strong>Content type:</strong> 🎬 Mixed Movies and Shows</li>
                            <li><strong>Display name:</strong> Anything you'd like! I use "Streaming"</li>
                            <li><strong>Folders:</strong> 📁 Use the default folder '/data/Jellyseerr' OR specify the same root folder as found under Library Settings > Library Directory</li>
                            <li><strong>Metadata savers:</strong> ☑️ Nfo</li>
                            <li>☑️ <strong>Save artwork into media folders</strong></li>
                            <li><strong>Subtitle downloaders:</strong> 🔳 Open Subtitles</li>
                        </ul>
                    </div>
                    
                    <div class="inputContainer">
                        <input is="emby-input" type="number" id="SyncIntervalHours" label="Sync Interval (Hours)" min="0" step="0.1"/>
                        <div class="fieldDescription">How often to sync with Jellyseerr (accepts partial hours, e.g., 1.5). Set to 0 to disable automatic syncing.</div>
                    </div>

                    <div class="inputContainer">
                        <input is="emby-input" type="url" id="JellyseerrUrl" label="Jellyseerr URL"/>
                        <div class="fieldDescription">The base URL of your Jellyseerr instance (e.g., http://host.docker.internal:5055)</div>
                    </div>

                    <div class="inputContainer">
                        <input is="emby-input" type="password" id="ApiKey" label="API Key" autocomplete="off" data-lpignore="true" data-form-type="other" />
                        <div class="fieldDescription">Your Jellyseerr API key</div>
                    </div>

                    <div>
                        <button is="emby-button" type="button" id="testConnection" class="raised button block emby-button">
                            <span>Test Connection</span>
                        </button>
                    </div>

                    <br>

                    <details id="librarySettings">
                        <summary>Library Settings</summary>
                        <br>
                        <div class="inputContainer">
                            <input is="emby-input" type="text" id="LibraryDirectory" label="Library Directory" />
                            <div class="fieldDescription">Directory path for Jellyseerr library files. Requires the word "Jellyseerr" in the name to automatically manage the library.</div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="ManageJellyseerrLibrary" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox" />
                                <span class="checkboxLabel">Manage Jellyseerr library</span>
                                <span class="checkboxOutline">
                                    <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                                    <span class="material-icons checkboxIcon checkboxIcon-unchecked" aria-hidden="true"></span>
                                </span>
                            </label>
                            <div class="fieldDescription">After syncing, refreshes all Jellyfin libraries that contain the <i>Library Directory</i> path. Runs a partial refresh "Search for missing metadata" (this should finish quickly), or a full refresh "Replace all metadata" if items are deleted from Jellyseerr (this takes a while). Uses default refresh settings: Replace all images, Keep existing trickplay images.</div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="ExcludeFromMainLibraries" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox" />
                                <span class="checkboxLabel">Exclude Jellyfin library media from streaming libraries</span>
                                <span class="checkboxOutline">
                                    <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                                    <span class="material-icons checkboxIcon checkboxIcon-unchecked" aria-hidden="true"></span>
                                </span>
                            </label>
                            <div class="fieldDescription">When enabled, the Jellyseerr library will exclude streaming movies and shows that appear in your Jellyfin libraries. Enabling this option will create a .ignore file (containing Jellyfin metadata) in the movie or show directory.</div>
                        </div>


                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="CreateSeparateLibraries" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox" />
                                <span class="checkboxLabel">Create separate libraries for streaming services</span>
                                <span class="checkboxOutline">
                                    <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                                    <span class="material-icons checkboxIcon checkboxIcon-unchecked" aria-hidden="true"></span>
                                </span>
                            </label>
                            <div class="fieldDescription">When enabled, separate libraries will be created for each streaming service, e.g., Netflix, Hulu, FOX.</div>
                            <div id="separateLibrariesWarning" class="fieldDescription cautionText" style="display: none;">
                                ⚠️ Caution: To display the items in the Jellyfin library without seeing the annoying folder icons, you must add network subdirectories to the Jellyfin Folders rather than the base Library Directory. Alternatively, you can use different libraries for each network provider.
                            </div>
                        </div>

                        <div class="inputContainer" id="LibraryPrefixContainer">
                            <input id="LibraryPrefix" type="text" is="emby-input" label="Library Prefix"/>
                            <div class="fieldDescription">Prefix for streaming service library names. The folder structure for the prefix "Network - " would look like:<br><code>/data/Jellyseerr/Network - FOX/The Matrix (1999)</code></div>
                        </div>


                        <div>
                            <button is="emby-button" type="button" id="syncFavorites" class="raised button block emby-button">
                                <span>Sync favorites from Jellyfin library to Jellyseerr</span>
                            </button>
                            <div id="syncFavoritesResult" class="testResult emby-textarea" style="display: none; margin-top: 10px; white-space: pre-wrap;"></div>
                        </div>

                    </details>

                    <br>

                    <details id="syncSettings">
                        <summary>Discover Settings</summary>
                        <br>

                        <div class="inputContainer">
                            <input id="MaxDiscoverPages" type="number" is="emby-input" min="0" label="Max Discover Pages"/>
                            <div class="fieldDescription">Maximum number of pages to fetch from discover endpoint for each network during sync. This applies to both movies and TV shows discovery. Enter 0 to retrieve ALL pages (unlimited). Default is 10.</div>
                        </div>

                        <div class="inputContainer">
                            <input id="MaxRetentionDays" type="number" is="emby-input" min="1" label="Max Retention Days"/>
                            <div class="fieldDescription">Maximum number of days to retain items in the collection before cleanup. Items older than this will be removed during sync operations. Default is 30 days.</div>
                        </div>

                        <div class="inputContainer" id="regionContainer">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="flex: 1;">
                                    <label class="inputLabel inputLabelUnfocused" for="selectWatchRegion">Region <span class="helpIcon" title="Click the refresh button to load all regions from Jellyseerr. Only unselected default networks from Jellyseerr's Network Slider are shown in the list.">?</span></label>
                                    <select id="selectWatchRegion" is="emby-input" class="emby-input emby-select">
                                        <option value="US">United States (US)</option>
                                    </select>
                                </div>
                                <button type="button" id="refreshNetworks" is="emby-button" class="raised button emby-button" style="margin-top: 30px; height: 40px; width: 40px; padding: 0; display: flex; align-items: center; justify-content: center;" title="Refresh regions">
                                    ↻
                                </button>
                            </div>
                            <div class="fieldDescription">Select your region for network services. This determines which streaming services are shown for movies and TV shows.</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="DefaultNetworks">Network Services</label>
                            <div class="fieldDescription">
                                Shown below as: Jellyseerr sort order #. Watch Provider Name (Provider ID #), and [REGION ID]
                            </div>
                            <div class="multiSelectContainer">
                                <!-- Active Networks (Left) -->
                                <div class="selectBox">
                                    <div class="selectBoxHeader">
                                        <label class="inputLabel">Synced from Jellyseerr</label>
                                    </div>
                                    <div class="searchInputContainer">
                                        <input type="text" id="activeNetworkSearch" placeholder="Search active networks..." class="emby-input">
                                        <button type="button" id="clearActiveNetworkSearch" class="clearSearchButton" title="Clear search">×</button>
                                    </div>
                                    <select id="activeNetworks" multiple is="emby-input" class="emby-input emby-select">
                                        <!-- Active networks will be populated here -->
                                    </select>
                                </div>
                                
                                <!-- Arrow Buttons (Center) -->
                                <div class="arrowButtonsContainer">
                                    <button type="button" id="refreshAvailableNetworks" is="emby-button" class="raised button emby-button arrowButton" title="Refresh available networks">↻</button>
                                    <button type="button" id="addSelectedNetworks" is="emby-button" class="raised button emby-button arrowButton" title="Add selected networks">←</button>
                                    <button type="button" id="removeSelectedNetworks" is="emby-button" class="raised button emby-button arrowButton" title="Remove selected networks">→</button>
                                </div>
                                
                                <!-- Available Networks (Right) -->
                                <div class="selectBox" id="availableNetworksSelectBox">
                                    <div class="selectBoxHeader">
                                        <label class="inputLabel">Available in Watch Network Region <span class="helpIcon" title="Click the refresh button to load all regions from Jellyseerr. Only the selected and default (US) region are shown in the list.">?</span></label>
                                    </div>
                                    <div class="searchInputContainer">
                                        <input type="text" id="availableNetworkSearch" placeholder="Search available networks..." class="emby-input">
                                        <button type="button" id="clearAvailableNetworkSearch" class="clearSearchButton" title="Clear search">×</button>
                                    </div>
                                    <select id="availableNetworks" multiple is="emby-input" class="emby-input emby-select">
                                        <!-- Available networks will be populated here -->
                                    </select>
                                </div>
                            </div>
                            <div class="fieldDescription">Select networks from the right box and move them to the left box. Use the search boxes to filter networks. Active networks will be used for filtering and categorization.</div>
                        </div>


                        <div>
                            <button is="emby-button" type="button" id="syncDiscover" class="raised button block emby-button">
                                <span>Sync discover content from Jellyseerr to Jellyfin library</span>
                            </button>
                            <div id="syncDiscoverResult" class="testResult emby-textarea" style="display: none; margin-top: 10px; white-space: pre-wrap;"></div>
                        </div>

                    </details>

                    <br>

                    <details id="advancedSettings">
                        <summary>Advanced</summary>
                        <br>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="AutoSyncOnStartup" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox" />
                                <span class="checkboxLabel">Auto-sync on Plugin Startup</span>
                                <span class="checkboxOutline">
                                    <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                                    <span class="material-icons checkboxIcon checkboxIcon-unchecked" aria-hidden="true"></span>
                                </span>
                            </label>
                            <div class="fieldDescription">Automatically perform a sync operation when the plugin starts up or when Jellyfin restarts.</div>
                        </div>

                        <div class="inputContainer" id="StartupDelaySecondsContainer">
                            <input id="StartupDelaySeconds" type="number" is="emby-input" min="0" max="900" label="Startup Delay (seconds)"/>
                            <div class="fieldDescription">Delay a number of seconds before running the auto-sync task on startup.</div>
                        </div>

                        <div class="inputContainer">
                            <input id="RequestTimeout" type="number" is="emby-input" min="1" max="3600" label="Request Timeout (seconds)"/>
                            <div class="fieldDescription">Timeout for API requests to Jellyseerr.</div>
                        </div>

                        <div class="inputContainer">
                            <input id="RetryAttempts" type="number" is="emby-input" min="0" max="100" label="Retry Attempts"/>
                            <div class="fieldDescription">Number of retry attempts for failed API requests to Jellyseerr.</div>
                        </div>

                        <div class="inputContainer">
                            <input id="PlaceholderDurationSeconds" type="number" is="emby-input" min="1" max="3600" label="Placeholder Video Duration (seconds)"/>
                            <div class="fieldDescription">Length of generated placeholder videos in the Jellyseerr library.</div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="EnableDebugLogging" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox" />
                                <span class="checkboxLabel">Enable Debug Logging</span>
                                <span class="checkboxOutline">
                                    <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                                    <span class="material-icons checkboxIcon checkboxIcon-unchecked" aria-hidden="true"></span>
                                </span>
                            </label>
                            <div class="fieldDescription">Enable detailed debug logging for troubleshooting. This will generate more verbose logs in the Jellyfin server logs.</div>
                        </div>

                        <div style="margin-top: 20px; padding: 15px; background-color: rgba(211, 47, 47, 0.1); border: 1px solid #d32f2f; border-radius: 5px;">
                            <button is="emby-button" type="button" id="deleteLibraryData" class="raised button block emby-button" style="background-color: #d32f2f; color: white;">
                                <span>Delete Jellyfin Library Data</span>
                            </button>
                            <div class="fieldDescription criticalText">
                                <strong>☠️ CRITICAL:</strong> This will permanently delete all library data from the library directory. This action may result in irreversible data loss. The prompt will ask for confirmation twice to confirm this action.
                            </div>
                            <div class="fieldDescription cautionText">
                                <strong>⚠️ IMPORTANT:</strong> After deleting library data, you should delete the Jellyfin library associated with Jellyseerr and recreate it using the setup instructions at the top of this page.
                            </div>
                        </div>

                    </details>

                    <br>

                    <div>
                        <button is="emby-button" type="submit" id="saveConfig" class="raised button-submit block emby-button">
                            <span>Save</span>
                        </button>
                    </div>
                    
                    <div style="margin-top: 10px;">
                        <button is="emby-button" type="button" id="resetPluginConfig" class="raised button block emby-button" style="background-color: #757575; border: 1px solid #bbb; color: white;">
                            <span>Reset Configuration</span>
                        </button>
                    </div>
                </fieldset>
            </form>
            
            <div style="margin-top: 20px; padding: 15px; background-color: rgba(0,0,0,0.1); border-radius: 5px; font-size: 0.9em; color: #888;">
                <p><strong>Credits & Acknowledgments:</strong></p>
                <p>Thank you to the creator of the <a href="https://github.com/geekfreak21/Overseer-and-Jellyfin-Bridged" target="_blank" style="color: #2196f3;"><strong>Overseer-Jellyfin Bridge Script</strong></a> for the inspiration. Special thanks to the developers of the <a href="https://github.com/intro-skipper" target="_blank" style="color: #2196f3;"><strong>Intro Skipper</strong></a> and <a href="https://github.com/IAmParadox27/jellyfin-plugin-custom-tabs" target="_blank" style="color: #2196f3;"><strong>Custom Tabs</strong></a> plugins for reusing their GPL-licensed code in the UI styling and configuration patterns.</p>
                <p>And of course, thanks to the developers of <a href="https://jellyfin.org/" target="_blank" style="color: #2196f3;"><strong>Jellyfin</strong></a> and <a href="https://seerr.dev/" target="_blank" style="color: #2196f3;"><strong>Jellyseerr</strong></a> for making it all possible.</p>
            </div>
        </div>
    </div>
</div>