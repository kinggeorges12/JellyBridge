<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
        <title>Jellyseerr Bridge v0.46 - Configuration</title>
</head>
<body>
    <div id="TemplateConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <div class="verticalSection">
                    <div class="sectionTitleContainer">
                        <h2 class="sectionTitle">Jellyseerr Bridge</h2>
                    </div>
                </div>
                <hr class="solid">
                
                <form id="JellyseerrConfigForm">
                    <fieldset class="verticalSection-extrabottompadding">
                        <legend>Basic Configuration</legend>
                        
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="IsEnabled" type="checkbox" is="emby-checkbox" checked />
                                <span>Enable Plugin</span>
                            </label>
                            <div class="fieldDescription">Enable or disable the Jellyseerr Bridge plugin</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused">Jellyseerr URL</label>
                            <input id="JellyseerrUrl" type="url" is="emby-input" value="http://localhost:5055" autocomplete="url" />
                            <div class="fieldDescription">The base URL of your Jellyseerr instance (e.g., http://localhost:5055)</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused">API Key</label>
                            <input id="ApiKey" type="password" is="emby-input" autocomplete="current-password" />
                            <div class="fieldDescription">Your Jellyseerr API key</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused">Library Directory</label>
                            <input id="LibraryDirectory" type="text" is="emby-input" value="/data/Jellyseerr" autocomplete="off" />
                            <div class="fieldDescription">Directory path for Jellyseerr library files</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused">User ID</label>
                            <input id="UserId" type="number" is="emby-input" min="1" value="1" autocomplete="off" />
                            <div class="fieldDescription">Jellyseerr user ID for requests</div>
                        </div>
                    </fieldset>

                    <fieldset class="verticalSection-extrabottompadding">
                        <legend>Advanced Settings</legend>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused">Sync Interval (Hours)</label>
                            <input id="SyncIntervalHours" type="number" is="emby-input" min="1" value="24" autocomplete="off" />
                            <div class="fieldDescription">How often to sync with Jellyseerr (in hours)</div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="ExcludeFromMainLibraries" type="checkbox" is="emby-checkbox" checked />
                                <span>Exclude placeholder shows from main libraries</span>
                            </label>
                            <div class="fieldDescription">Hide placeholder shows from your main Jellyfin libraries</div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="CreateSeparateLibraries" type="checkbox" is="emby-checkbox" />
                                <span>Create separate libraries for streaming services</span>
                            </label>
                            <div class="fieldDescription">Create dedicated libraries for each streaming service</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused">Library Prefix</label>
                            <input id="LibraryPrefix" type="text" is="emby-input" value="Streaming - " autocomplete="off" />
                            <div class="fieldDescription">Prefix for streaming service library names</div>
                        </div>
                    </fieldset>

                    <button id="testConnection" is="emby-button" type="button" class="emby-button raised block" style="width: 100%; margin-bottom: 1em;">
                        <span>Test Connection</span>
                    </button>

                    <button id="saveConfig" is="emby-button" type="submit" class="emby-button raised button-submit block" style="width: 100%;">
                        <span>Save</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // Configuration fields
        const configurationFields = [
            "JellyseerrUrl",
            "ApiKey", 
            "LibraryDirectory",
            "UserId",
            "SyncIntervalHours",
            "LibraryPrefix"
        ];

        const booleanConfigurationFields = [
            "IsEnabled",
            "ExcludeFromMainLibraries",
            "CreateSeparateLibraries"
        ];

        // Load configuration on page load
        document.addEventListener("DOMContentLoaded", function() {
            ApiClient.getPluginConfiguration("8ecc808c-d6e9-432f-9219-b638fbfb37e6")
                .then((config) => {
                    // Set text field values
                    for (const field of configurationFields) {
                        const element = document.querySelector("#" + field);
                        if (element && config[field] !== undefined) {
                            element.value = config[field];
                        }
                    }

                    // Set checkbox values
                    for (const field of booleanConfigurationFields) {
                        const element = document.querySelector("#" + field);
                        if (element && config[field] !== undefined) {
                            element.checked = config[field];
                        }
                    }
                })
                .catch((error) => {
                    // Set defaults if config load fails
                    document.querySelector("#IsEnabled").checked = true;
                    document.querySelector("#JellyseerrUrl").value = 'http://localhost:5055';
                    document.querySelector("#ApiKey").value = '';
                    document.querySelector("#LibraryDirectory").value = '/data/Jellyseerr';
                    document.querySelector("#UserId").value = 1;
                    document.querySelector("#SyncIntervalHours").value = 24;
                    document.querySelector("#ExcludeFromMainLibraries").checked = true;
                    document.querySelector("#CreateSeparateLibraries").checked = false;
                    document.querySelector("#LibraryPrefix").value = 'Streaming - ';
                });
        });

        // Handle form submission
        document.querySelector("#JellyseerrConfigForm").addEventListener("submit", (e) => {
            Dashboard.showLoadingMsg();
            ApiClient.getPluginConfiguration("8ecc808c-d6e9-432f-9219-b638fbfb37e6")
                .then((config) => {
                    // Update text field values
                    for (const field of configurationFields) {
                        config[field] = document.querySelector("#" + field).value;
                    }

                    // Update checkbox values
                    for (const field of booleanConfigurationFields) {
                        config[field] = document.querySelector("#" + field).checked;
                    }

                    ApiClient.updatePluginConfiguration("8ecc808c-d6e9-432f-9219-b638fbfb37e6", config)
                        .then(Dashboard.processPluginConfigurationUpdateResult)
                        .finally(function () {
                            Dashboard.hideLoadingMsg();
                        });
                })
                .catch((error) => {
                    Dashboard.hideLoadingMsg();
                });

            e.preventDefault();
            return false;
        });

        // Handle test connection button
        document.querySelector("#testConnection").addEventListener("click", function() {
            Dashboard.showLoadingMsg();
            
            const url = document.querySelector("#JellyseerrUrl").value;
            const apiKey = document.querySelector("#ApiKey").value;
            
            if (!url) {
                Dashboard.hideLoadingMsg();
                Dashboard.alert('Please enter a Jellyseerr URL first');
                return;
            }

            const testData = {
                JellyseerrUrl: url,
                ApiKey: apiKey
            };

            ApiClient.fetch({
                url: ApiClient.getUrl('JellyseerrBridge/TestConnection'),
                method: 'POST',
                data: JSON.stringify(testData),
                contentType: 'application/json'
            }).then(function (response) {
                Dashboard.hideLoadingMsg();
                if (response.success) {
                    Dashboard.alert('✅ ' + response.message);
                } else {
                    Dashboard.alert('❌ ' + response.message);
                }
            }).catch(function (error) {
                Dashboard.hideLoadingMsg();
                Dashboard.alert('❌ Connection test failed: ' + error.message);
            });
        });
    </script>
</body>
</html>