<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Jellyseerr Bridge v0.44 - Configuration</title>
</head>
<body>
    <div id="TemplateConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <div class="verticalSection">
                    <div class="sectionTitleContainer">
                        <h2 class="sectionTitle">Jellyseerr Bridge</h2>
                    </div>
                </div>
                <hr class="solid">
                
                <form id="JellyseerrConfigForm">
                    <fieldset class="verticalSection-extrabottompadding">
                        <legend>Basic Configuration</legend>
                        
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="IsEnabled" type="checkbox" is="emby-checkbox" checked />
                                <span>Enable Plugin</span>
                            </label>
                            <div class="fieldDescription">Enable or disable the Jellyseerr Bridge plugin</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused">Jellyseerr URL</label>
                            <input id="JellyseerrUrl" type="url" is="emby-input" value="http://localhost:5055" autocomplete="url" />
                            <div class="fieldDescription">The base URL of your Jellyseerr instance (e.g., http://localhost:5055)</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused">API Key</label>
                            <input id="ApiKey" type="password" is="emby-input" autocomplete="current-password" />
                            <div class="fieldDescription">Your Jellyseerr API key</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused">Library Directory</label>
                            <input id="LibraryDirectory" type="text" is="emby-input" value="/data/Jellyseerr" autocomplete="off" />
                            <div class="fieldDescription">Directory path for Jellyseerr library files</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused">User ID</label>
                            <input id="UserId" type="number" is="emby-input" min="1" value="1" autocomplete="off" />
                            <div class="fieldDescription">Jellyseerr user ID for requests</div>
                        </div>
                    </fieldset>

                    <fieldset class="verticalSection-extrabottompadding">
                        <legend>Advanced Settings</legend>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused">Sync Interval (Hours)</label>
                            <input id="SyncIntervalHours" type="number" is="emby-input" min="1" value="24" autocomplete="off" />
                            <div class="fieldDescription">How often to sync with Jellyseerr (in hours)</div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="ExcludeFromMainLibraries" type="checkbox" is="emby-checkbox" checked />
                                <span>Exclude placeholder shows from main libraries</span>
                            </label>
                            <div class="fieldDescription">Hide placeholder shows from your main Jellyfin libraries</div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="CreateSeparateLibraries" type="checkbox" is="emby-checkbox" />
                                <span>Create separate libraries for streaming services</span>
                            </label>
                            <div class="fieldDescription">Create dedicated libraries for each streaming service</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused">Library Prefix</label>
                            <input id="LibraryPrefix" type="text" is="emby-input" value="Streaming - " autocomplete="off" />
                            <div class="fieldDescription">Prefix for streaming service library names</div>
                        </div>
                    </fieldset>

                    <button id="testConnection" is="emby-button" type="button" class="emby-button raised block" style="width: 100%; margin-bottom: 1em;">
                        <span>Test Connection</span>
                    </button>

                    <button id="saveConfig" is="emby-button" type="submit" class="emby-button raised button-submit block" style="width: 100%;">
                        <span>Save</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        if (typeof JellyseerrConfig == 'undefined') {
            const JellyseerrConfig = {
                pluginId: "8ecc808c-d6e9-432f-9219-b638fbfb37e6",
                form: document.querySelector("#JellyseerrConfigForm"),
                btnSave: document.querySelector("#saveConfig"),
                btnTest: document.querySelector("#testConnection"),

                saveConfig: function (e) {
                    e.preventDefault();
                    console.log('[JellyseerrBridge] Save configuration button clicked');
                    Dashboard.showLoadingMsg();
                    
                    const config = {
                        IsEnabled: document.querySelector("#IsEnabled").checked,
                        JellyseerrUrl: document.querySelector("#JellyseerrUrl").value,
                        ApiKey: document.querySelector("#ApiKey").value,
                        LibraryDirectory: document.querySelector("#LibraryDirectory").value,
                        UserId: parseInt(document.querySelector("#UserId").value),
                        SyncIntervalHours: parseInt(document.querySelector("#SyncIntervalHours").value),
                        ExcludeFromMainLibraries: document.querySelector("#ExcludeFromMainLibraries").checked,
                        CreateSeparateLibraries: document.querySelector("#CreateSeparateLibraries").checked,
                        LibraryPrefix: document.querySelector("#LibraryPrefix").value
                    };

                    console.log('[JellyseerrBridge] Saving configuration:', {
                        IsEnabled: config.IsEnabled,
                        JellyseerrUrl: config.JellyseerrUrl,
                        HasApiKey: config.ApiKey ? 'Yes' : 'No',
                        LibraryDirectory: config.LibraryDirectory,
                        UserId: config.UserId,
                        SyncIntervalHours: config.SyncIntervalHours,
                        ExcludeFromMainLibraries: config.ExcludeFromMainLibraries,
                        CreateSeparateLibraries: config.CreateSeparateLibraries,
                        LibraryPrefix: config.LibraryPrefix
                    });

                    window.ApiClient.updatePluginConfiguration(JellyseerrConfig.pluginId, config)
                        .then(function(result) {
                            console.log('[JellyseerrBridge] Configuration save successful:', result);
                            Dashboard.processPluginConfigurationUpdateResult(result);
                            Dashboard.alert('Settings saved successfully!');
                        })
                        .catch(function (error) {
                            console.error('[JellyseerrBridge] Save configuration error:', error);
                            Dashboard.alert('Error saving settings: ' + error.message);
                        })
                        .finally(function () {
                            console.log('[JellyseerrBridge] Save configuration process completed');
                            Dashboard.hideLoadingMsg();
                        });
                },

                testConnection: function () {
                    console.log('[JellyseerrBridge] Test connection button clicked');
                    Dashboard.showLoadingMsg();
                    
                    const url = document.querySelector("#JellyseerrUrl").value;
                    const apiKey = document.querySelector("#ApiKey").value;
                    
                    console.log('[JellyseerrBridge] Testing connection to:', url, 'with API key:', apiKey ? 'Yes' : 'No');
                    
                    if (!url) {
                        console.log('[JellyseerrBridge] Test connection failed: No URL provided');
                        Dashboard.alert('Please enter a Jellyseerr URL first');
                        Dashboard.hideLoadingMsg();
                        return;
                    }

                    const testData = {
                        JellyseerrUrl: url,
                        ApiKey: apiKey
                    };

                    console.log('[JellyseerrBridge] Sending test connection request:', testData);

                    window.ApiClient.fetch({
                        url: ApiClient.getUrl('JellyseerrBridge/TestConnection'),
                        method: 'POST',
                        data: JSON.stringify(testData),
                        contentType: 'application/json'
                    }).then(function (response) {
                        console.log('[JellyseerrBridge] Test connection response received:', response);
                        if (response.success) {
                            console.log('[JellyseerrBridge] Test connection successful:', response.message);
                            Dashboard.alert('✅ ' + response.message);
                        } else {
                            console.log('[JellyseerrBridge] Test connection failed:', response.message);
                            Dashboard.alert('❌ ' + response.message);
                        }
                    }).catch(function (error) {
                        console.error('[JellyseerrBridge] Connection test error:', error);
                        Dashboard.alert('❌ Connection test failed: ' + error.message);
                    }).finally(function () {
                        console.log('[JellyseerrBridge] Test connection process completed');
                        Dashboard.hideLoadingMsg();
                    });
                },

                loadConfig: function () {
                    console.log('[JellyseerrBridge] Loading configuration from server');
                    Dashboard.showLoadingMsg();

                    window.ApiClient.getPluginConfiguration(JellyseerrConfig.pluginId)
                        .then(function (config) {
                            console.log('[JellyseerrBridge] Configuration loaded successfully:', config);
                            document.querySelector("#IsEnabled").checked = config.IsEnabled !== false;
                            document.querySelector("#JellyseerrUrl").value = config.JellyseerrUrl || 'http://localhost:5055';
                            document.querySelector("#ApiKey").value = config.ApiKey || '';
                            document.querySelector("#LibraryDirectory").value = config.LibraryDirectory || '/data/Jellyseerr';
                            document.querySelector("#UserId").value = config.UserId || 1;
                            document.querySelector("#SyncIntervalHours").value = config.SyncIntervalHours || 24;
                            document.querySelector("#ExcludeFromMainLibraries").checked = config.ExcludeFromMainLibraries !== false;
                            document.querySelector("#CreateSeparateLibraries").checked = config.CreateSeparateLibraries || false;
                            document.querySelector("#LibraryPrefix").value = config.LibraryPrefix || 'Streaming - ';
                            console.log('[JellyseerrBridge] Configuration form populated with loaded values');
                        }).catch(function (error) {
                            console.error('[JellyseerrBridge] Configuration load error:', error);
                            console.log('[JellyseerrBridge] Setting default values due to load error');
                            // Set defaults if config load fails
                            document.querySelector("#IsEnabled").checked = true;
                            document.querySelector("#JellyseerrUrl").value = 'http://localhost:5055';
                            document.querySelector("#ApiKey").value = '';
                            document.querySelector("#LibraryDirectory").value = '/data/Jellyseerr';
                            document.querySelector("#UserId").value = 1;
                            document.querySelector("#SyncIntervalHours").value = 24;
                            document.querySelector("#ExcludeFromMainLibraries").checked = true;
                            document.querySelector("#CreateSeparateLibraries").checked = false;
                            document.querySelector("#LibraryPrefix").value = 'Streaming - ';
                        }).finally(function () {
                            console.log('[JellyseerrBridge] Configuration load process completed');
                            Dashboard.hideLoadingMsg();
                        });
                },

                init: function () {
                    console.log('[JellyseerrBridge] Initializing configuration page');
                    // Set defaults first
                    document.querySelector("#IsEnabled").checked = true;
                    document.querySelector("#JellyseerrUrl").value = 'http://localhost:5055';
                    document.querySelector("#ApiKey").value = '';
                    document.querySelector("#LibraryDirectory").value = '/data/Jellyseerr';
                    document.querySelector("#UserId").value = 1;
                    document.querySelector("#SyncIntervalHours").value = 24;
                    document.querySelector("#ExcludeFromMainLibraries").checked = true;
                    document.querySelector("#CreateSeparateLibraries").checked = false;
                    document.querySelector("#LibraryPrefix").value = 'Streaming - ';
                    console.log('[JellyseerrBridge] Default values set');

                    // Add event listeners
                    JellyseerrConfig.btnSave.addEventListener("click", JellyseerrConfig.saveConfig);
                    JellyseerrConfig.btnTest.addEventListener("click", JellyseerrConfig.testConnection);
                    console.log('[JellyseerrBridge] Event listeners attached');
                    
                    // Load saved config (will override defaults if config exists)
                    JellyseerrConfig.loadConfig();
                }
            };

            document.querySelector('#TemplateConfigPage').addEventListener("pageshow", function () {
                console.log('[JellyseerrBridge] Configuration page shown');
                JellyseerrConfig.init();
            });
        }
    </script>
</body>
</html>