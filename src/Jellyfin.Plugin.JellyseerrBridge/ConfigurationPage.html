<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Jellyseerr Bridge v0.35 - REMOVED WEBHOOK PORT</title>
</head>
<body>
    <div id="TemplateConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="JellyseerrConfigForm">
                    <fieldset class="verticalSection-extrabottompadding">
                        <legend>Basic Configuration</legend>
                        
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="IsEnabled" type="checkbox" is="emby-checkbox" />
                                <span>Enable Plugin</span>
                            </label>
                            <div class="fieldDescription">Enable or disable the Jellyseerr Bridge plugin</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused">Jellyseerr URL</label>
                            <input id="JellyseerrUrl" type="text" is="emby-input" />
                            <div class="fieldDescription">The base URL of your Jellyseerr instance (e.g., http://localhost:5055)</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused">API Key</label>
                            <input id="ApiKey" type="password" is="emby-input" />
                            <div class="fieldDescription">Your Jellyseerr API key</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused">Library Directory</label>
                            <input id="LibraryDirectory" type="text" is="emby-input" />
                            <div class="fieldDescription">Directory path for Jellyseerr library files</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused">User ID</label>
                            <input id="UserId" type="number" is="emby-input" min="1" />
                            <div class="fieldDescription">Jellyseerr user ID for requests</div>
                        </div>

                        <button id="testConnection" is="emby-button" type="button" class="emby-button raised block" style="width: 100%; margin-bottom: 1em;">
                            <span>Test Connection</span>
                        </button>
                    </fieldset>

                    <fieldset class="verticalSection-extrabottompadding">
                        <legend>Advanced Settings</legend>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused">Sync Interval (Hours)</label>
                            <input id="SyncIntervalHours" type="number" is="emby-input" min="1" />
                            <div class="fieldDescription">How often to sync with Jellyseerr (in hours)</div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="ExcludeFromMainLibraries" type="checkbox" is="emby-checkbox" />
                                <span>Exclude placeholder shows from main libraries</span>
                            </label>
                            <div class="fieldDescription">Hide placeholder shows from your main Jellyfin libraries</div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="CreateSeparateLibraries" type="checkbox" is="emby-checkbox" />
                                <span>Create separate libraries for streaming services</span>
                            </label>
                            <div class="fieldDescription">Create dedicated libraries for each streaming service</div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused">Library Prefix</label>
                            <input id="LibraryPrefix" type="text" is="emby-input" />
                            <div class="fieldDescription">Prefix for streaming service library names</div>
                        </div>
                    </fieldset>

                    <button id="saveConfig" is="emby-button" type="submit" class="emby-button raised button-submit block" style="width: 100%;">
                        <span>Save Configuration</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        if (typeof JellyseerrConfig == 'undefined') {
            const JellyseerrConfig = {
                pluginId: "8ecc808c-d6e9-432f-9219-b638fbfb37e6",
                form: document.querySelector("#JellyseerrConfigForm"),
                btnSave: document.querySelector("#saveConfig"),
                btnTest: document.querySelector("#testConnection"),

                saveConfig: function (e) {
                    e.preventDefault();
                    Dashboard.showLoadingMsg();

                    const config = {
                        IsEnabled: document.querySelector("#IsEnabled").checked,
                        JellyseerrUrl: document.querySelector("#JellyseerrUrl").value,
                        ApiKey: document.querySelector("#ApiKey").value,
                        LibraryDirectory: document.querySelector("#LibraryDirectory").value,
                        UserId: parseInt(document.querySelector("#UserId").value) || 1,
                        SyncIntervalHours: parseInt(document.querySelector("#SyncIntervalHours").value) || 24,
                        ExcludeFromMainLibraries: document.querySelector("#ExcludeFromMainLibraries").checked,
                        CreateSeparateLibraries: document.querySelector("#CreateSeparateLibraries").checked,
                        LibraryPrefix: document.querySelector("#LibraryPrefix").value
                    };

                    window.ApiClient.updatePluginConfiguration(JellyseerrConfig.pluginId, config)
                        .then(Dashboard.processPluginConfigurationUpdateResult)
                        .catch(function (error) {
                            console.error('Configuration save error:', error);
                            Dashboard.alert('❌ Failed to save configuration: ' + error.message);
                        })
                        .finally(function () {
                            Dashboard.hideLoadingMsg();
                        });
                },

                testConnection: function () {
                    Dashboard.showLoadingMsg();
                    
                    const url = document.querySelector("#JellyseerrUrl").value;
                    const apiKey = document.querySelector("#ApiKey").value;
                    
                    if (!url) {
                        Dashboard.alert('Please enter a Jellyseerr URL first');
                        Dashboard.hideLoadingMsg();
                        return;
                    }

                    // Use backend API for proper connection testing
                    const testData = {
                        JellyseerrUrl: url,
                        ApiKey: apiKey
                    };

                    ApiClient.ajax({
                        url: ApiClient.getUrl('Plugins/JellyseerrBridge/TestConnection'),
                        type: 'POST',
                        data: JSON.stringify(testData),
                        contentType: 'application/json'
                    }).then(function (response) {
                        if (response.success) {
                            Dashboard.alert('✅ ' + response.message);
                        } else {
                            Dashboard.alert('❌ ' + response.message);
                        }
                    }).catch(function (error) {
                        console.error('Connection test error:', error);
                        Dashboard.alert('❌ Connection test failed: ' + error.message);
                    }).finally(function () {
                        Dashboard.hideLoadingMsg();
                    });
                },

                loadConfig: function () {
                    Dashboard.showLoadingMsg();

                    ApiClient.ajax({
                        url: ApiClient.getUrl('Plugins/Configuration', { key: JellyseerrConfig.pluginId }),
                        type: 'GET'
                    }).then(function (config) {
                        document.querySelector("#IsEnabled").checked = config.IsEnabled !== false;
                        document.querySelector("#JellyseerrUrl").value = config.JellyseerrUrl || 'http://localhost:5055';
                        document.querySelector("#ApiKey").value = config.ApiKey || '';
                        document.querySelector("#LibraryDirectory").value = config.LibraryDirectory || '/data/Jellyseerr';
                        document.querySelector("#UserId").value = config.UserId || 1;
                        document.querySelector("#SyncIntervalHours").value = config.SyncIntervalHours || 24;
                        document.querySelector("#ExcludeFromMainLibraries").checked = config.ExcludeFromMainLibraries !== false;
                        document.querySelector("#CreateSeparateLibraries").checked = config.CreateSeparateLibraries || false;
                        document.querySelector("#LibraryPrefix").value = config.LibraryPrefix || 'Streaming - ';
                    }).catch(function (error) {
                        console.error('Configuration load error:', error);
                        // Set defaults if config load fails
                        document.querySelector("#IsEnabled").checked = true;
                        document.querySelector("#JellyseerrUrl").value = 'http://localhost:5055';
                        document.querySelector("#ApiKey").value = '';
                        document.querySelector("#LibraryDirectory").value = '/data/Jellyseerr';
                        document.querySelector("#UserId").value = 1;
                        document.querySelector("#SyncIntervalHours").value = 24;
                        document.querySelector("#ExcludeFromMainLibraries").checked = true;
                        document.querySelector("#CreateSeparateLibraries").checked = false;
                        document.querySelector("#LibraryPrefix").value = 'Streaming - ';
                    }).finally(function () {
                        Dashboard.hideLoadingMsg();
                    });
                },

                init: function () {
                    // Set defaults first
                    document.querySelector("#IsEnabled").checked = true;
                    document.querySelector("#JellyseerrUrl").value = 'http://localhost:5055';
                    document.querySelector("#ApiKey").value = '';
                    document.querySelector("#LibraryDirectory").value = '/data/Jellyseerr';
                    document.querySelector("#UserId").value = 1;
                    document.querySelector("#SyncIntervalHours").value = 24;
                    document.querySelector("#ExcludeFromMainLibraries").checked = true;
                    document.querySelector("#CreateSeparateLibraries").checked = false;
                    document.querySelector("#LibraryPrefix").value = 'Streaming - ';

                    // Add event listeners
                    JellyseerrConfig.btnSave.addEventListener("click", JellyseerrConfig.saveConfig);
                    JellyseerrConfig.btnTest.addEventListener("click", JellyseerrConfig.testConnection);
                    
                    // Load saved config (will override defaults if config exists)
                    JellyseerrConfig.loadConfig();
                }
            };

            document.querySelector('#TemplateConfigPage').addEventListener("pageshow", function () {
                JellyseerrConfig.init();
            });
        }
    </script>
</body>
</html>